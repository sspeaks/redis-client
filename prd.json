{
  "project": "redis-client",
  "branchName": "ralph/cluster-performance-parity",
  "description": "Achieve cluster throughput within 10% of StackExchange.Redis by building benchmark harnesses, profiling, and iteratively optimizing the MultiplexPool/Multiplexer code path",
  "userStories": [
    {
      "id": "US-001",
      "title": "C# StackExchange.Redis Benchmark Harness",
      "description": "As a developer, I want a C# console application that benchmarks StackExchange.Redis cluster SET, GET, and mixed workloads so that I have a baseline to compare against.",
      "acceptanceCriteria": [
        "C# .NET 8 console app in benchmarks/dotnet/ directory",
        "Accepts command-line args: --host, --port, --password, --tls, --operation (set/get/mixed), --duration (seconds), --key-size, --value-size, --connections (multiplexer count)",
        "SET workload: pipeline SET commands with random keys/values",
        "GET workload: pre-populate keys, then pipeline GET commands",
        "Mixed workload: 80% GET / 20% SET ratio",
        "Outputs JSON results: { operation, ops_per_sec, duration_sec, total_ops }",
        "Uses ConnectionMultiplexer with cluster mode enabled and TLS",
        "Uses async/await with FireAndForget flag disabled (waits for responses)",
        "Key size and value size are configurable (default: 16-byte keys, 256-byte values)",
        "Typecheck passes (dotnet build succeeds)"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Haskell redis-client Benchmark Mode",
      "description": "As a developer, I want a bench subcommand in redis-client that benchmarks cluster SET, GET, and mixed workloads so that I can compare against the C# harness.",
      "acceptanceCriteria": [
        "New bench subcommand added to redis-client executable",
        "Accepts flags: --operation (set/get/mixed), --duration (seconds, default 30), --key-size (default 16), --value-size (default 256), --connections (multiplexer count, default 1)",
        "Existing -h, -p, -a, -t, -c flags work with bench",
        "SET workload: submits SET commands through MultiplexPool with concurrent submitters",
        "GET workload: pre-populates keys, then submits GET commands through MultiplexPool",
        "Mixed workload: 80% GET / 20% SET ratio",
        "Outputs JSON: { operation, ops_per_sec, duration_sec, total_ops }",
        "Uses the same MultiplexPool/submitToNode code path as the library API",
        "Measures wall-clock time and counts completed operations",
        "cabal build succeeds",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Benchmark Runner Script",
      "description": "As a developer, I want a script that runs both benchmarks against the same cluster and produces a comparison report so that I can quickly see the performance gap.",
      "acceptanceCriteria": [
        "Shell script at benchmarks/run-comparison.sh",
        "Accepts args: --host, --port, --password, --tls, --duration",
        "Runs C# benchmark for set, get, mixed workloads",
        "Runs Haskell benchmark for set, get, mixed workloads",
        "Collects JSON output from both",
        "Prints a summary table: operation, SE.Redis ops/sec, redis-client ops/sec, ratio (%)",
        "Exits with code 0 if all ratios are >= 90%, code 1 otherwise",
        "Typecheck passes (shellcheck clean)"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Baseline Measurement and Profiling",
      "description": "As a developer, I want to run the initial benchmark comparison and profile redis-client to identify the top bottlenecks so that I know where to optimize.",
      "acceptanceCriteria": [
        "Run benchmarks/run-comparison.sh against the AMR E5 cluster",
        "Record baseline results in benchmarks/results/baseline.json",
        "Profile redis-client bench with +RTS -p for each workload",
        "Identify top 3 cost centers from .prof output",
        "Document findings in benchmarks/results/baseline-analysis.md",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Optimize Multiplexer Write Path",
      "description": "As a developer, I want to optimize the Multiplexer's command batching and serialization so that write throughput improves.",
      "acceptanceCriteria": [
        "Review writerLoop in Multiplexer.hs for unnecessary allocations",
        "Ensure Builder.toLazyByteString batching is optimal (no intermediate strict copies)",
        "Consider using sendMany or vectored I/O if the Client typeclass supports it",
        "Benchmark shows improvement over baseline for SET workload",
        "No regressions in GET or mixed workloads",
        "All existing tests pass (make test-unit)",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Optimize Multiplexer Read Path",
      "description": "As a developer, I want to optimize the Multiplexer's RESP parsing and response dispatch so that read throughput improves.",
      "acceptanceCriteria": [
        "Review readerLoop and parseOneResp in Multiplexer.hs for bottlenecks",
        "Minimize allocations in the hot parse loop (avoid unnecessary boxing)",
        "Ensure ResponseSlot IORef writes are not contended",
        "Consider parsing multiple responses per recv call if buffer has data",
        "Benchmark shows improvement for GET workload",
        "No regressions in SET or mixed workloads",
        "All existing tests pass (make test-unit)",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Optimize Connection and Submission Overhead",
      "description": "As a developer, I want to reduce per-command overhead in MultiplexPool.submitToNode so that the overall command submission path is faster.",
      "acceptanceCriteria": [
        "Profile submitToNode -> getMultiplexer -> submitCommand hot path",
        "Reduce allocations per command (ResponseSlot, MVar, IORef creation)",
        "Consider object pooling for ResponseSlot if allocation is a bottleneck",
        "Ensure getMultiplexer lock-free read path has no unnecessary work",
        "Benchmark shows improvement for all workloads",
        "All existing tests pass (make test-unit)",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Optimize RESP Serialization",
      "description": "As a developer, I want to optimize how commands are serialized to RESP protocol format so that serialization is not a bottleneck.",
      "acceptanceCriteria": [
        "Profile RESP encoding (Builder construction) in the benchmark workload",
        "Ensure encode for simple SET/GET commands doesn't allocate unnecessarily",
        "Pre-compute fixed protocol overhead (e.g., *3\\r\\n$3\\r\\nSET\\r\\n) as constants",
        "Benchmark shows serialization is <5% of total time or has improved",
        "All existing tests pass (make test-unit)",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Concurrency Tuning",
      "description": "As a developer, I want to find the optimal concurrency settings (number of submitter threads, connections per node) so that redis-client achieves peak throughput.",
      "acceptanceCriteria": [
        "Benchmark with varying submitter thread counts (1, 2, 4, 8, 16, 32, 64)",
        "Benchmark with varying multiplexer counts per node (1, 2, 4)",
        "Document the optimal configuration for the AMR E5 cluster",
        "Update default bench settings if current defaults are suboptimal",
        "Results recorded in benchmarks/results/concurrency-tuning.json",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Final Validation â€” Achieve 10% Parity",
      "description": "As a developer, I want to run the final benchmark comparison and confirm redis-client is within 10% of StackExchange.Redis throughput so that the performance goal is met.",
      "acceptanceCriteria": [
        "Run benchmarks/run-comparison.sh with the optimized redis-client",
        "SET workload: redis-client ops/sec >= 90% of StackExchange.Redis",
        "GET workload: redis-client ops/sec >= 90% of StackExchange.Redis",
        "Mixed workload: redis-client ops/sec >= 90% of StackExchange.Redis",
        "Results saved to benchmarks/results/final.json",
        "No existing tests broken (make test-unit)",
        "Comparison script exits with code 0",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    }
  ]
}
