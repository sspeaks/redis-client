{
  "project": "redis-client",
  "branchName": "ralph/separate-library-package",
  "description": "Separate hask-redis-mux library from redis-client CLI into two Cabal packages in the same repo, publishable to Hackage without performance regression",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create hask-redis-mux.cabal with all library components",
      "description": "As a library maintainer, I want a standalone cabal file for the library so it can be published to Hackage independently.",
      "acceptanceCriteria": [
        "Create hask-redis-mux.cabal with package name hask-redis-mux",
        "Include all 6 internal libraries: resp, client, crc16, redis-command-client, cluster, redis",
        "The redis library has visibility: public",
        "Include common defaults stanza with GHC2021 and -Wall",
        "cabal-version is 3.0",
        "Include proper Hackage metadata: synopsis, description, license (MIT), author (Seth Speaks), maintainer, category (Network), source-repository stanza",
        "Does NOT include any CLI-only dependencies (readline, process, random, directory, filepath)",
        "Does NOT include any executables or app/ code",
        "C source lib/crc16/crc16.c is included in the crc16 library",
        "Typecheck passes: nix-shell --run 'cabal build hask-redis-mux'"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Copy library stanzas directly from existing redis-client.cabal. Keep all dependency versions and module lists identical."
    },
    {
      "id": "US-002",
      "title": "Move unit test suites to hask-redis-mux.cabal",
      "description": "As a library maintainer, I want unit tests in the library package so they ship with the library and run during cabal test.",
      "acceptanceCriteria": [
        "RespSpec test suite is in hask-redis-mux.cabal with correct dependencies and hs-source-dirs",
        "ClusterSpec test suite is in hask-redis-mux.cabal with correct dependencies and hs-source-dirs",
        "ClusterCommandSpec test suite is in hask-redis-mux.cabal with correct dependencies and hs-source-dirs",
        "All three test suites pass: nix-shell --run 'cabal test RespSpec ClusterSpec ClusterCommandSpec'",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "These tests only depend on library modules, not app/ code. Move them verbatim."
    },
    {
      "id": "US-003",
      "title": "Update redis-client.cabal to depend on hask-redis-mux",
      "description": "As a CLI developer, I want redis-client to depend on the library package instead of defining its own library stanzas.",
      "acceptanceCriteria": [
        "redis-client.cabal no longer contains library stanzas (resp, client, crc16, redis-command-client, cluster, redis)",
        "redis-client executable depends on hask-redis-mux instead of internal libraries",
        "FillHelpersSpec test suite remains in redis-client.cabal and depends on hask-redis-mux",
        "E2E executables (EndToEnd, ClusterEndToEnd, LibraryE2E) remain behind e2e flag and depend on hask-redis-mux",
        "All app/ modules (Main, AppConfig, ClusterCli, ClusterFiller, ClusterSetup, ClusterTunnel, FillHelpers, Filler, SlotMappingHelpers) are listed",
        "RTS flags on redis-client executable unchanged: -O2 -threaded -rtsopts '-with-rtsopts=-N -H1024M -A128m -n8m -qb'",
        "data/ directory belongs to redis-client package",
        "Typecheck passes: nix-shell --run 'cabal build redis-client'",
        "FillHelpersSpec passes: nix-shell --run 'cabal test FillHelpersSpec'"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Replace internal library references (resp, client, cluster, etc.) with hask-redis-mux in build-depends. The executable and E2E tests import the same modules but via the hask-redis-mux package."
    },
    {
      "id": "US-004",
      "title": "Update cabal.project for multi-package build",
      "description": "As a developer, I want cabal.project to list both packages so cabal build all works.",
      "acceptanceCriteria": [
        "cabal.project lists both hask-redis-mux.cabal and redis-client.cabal as packages",
        "cabal build all succeeds: nix-shell --run 'cabal build all'",
        "cabal test all succeeds: nix-shell --run 'cabal test all'",
        "Existing cabal.project.local settings continue to work",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "May need to add 'packages: hask-redis-mux.cabal redis-client.cabal' or use glob patterns."
    },
    {
      "id": "US-005",
      "title": "Update Nix build files for two-package structure",
      "description": "As a developer, I want nix-build and nix-shell to continue working with the split packages.",
      "acceptanceCriteria": [
        "default.nix updated to build both packages",
        "flake.nix updated if it references the cabal file",
        "shell.nix continues to provide a working development shell",
        "nix-build succeeds",
        "nix-shell --run 'cabal build all' succeeds",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Check default.nix, flake.nix, and shell.nix for hardcoded references to redis-client.cabal."
    },
    {
      "id": "US-006",
      "title": "Update Makefile for two-package structure",
      "description": "As a developer, I want make build and make test to work with the split packages.",
      "acceptanceCriteria": [
        "make build succeeds and builds both packages",
        "make test-unit runs all 4 unit test suites (RespSpec, ClusterSpec, ClusterCommandSpec, FillHelpersSpec)",
        "make test passes end-to-end (if Docker is available)",
        "make clean cleans both packages",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "The Makefile may need minimal changes since it uses cabal commands that should work with the multi-package setup."
    },
    {
      "id": "US-007",
      "title": "Validate Hackage readiness of hask-redis-mux",
      "description": "As a library maintainer, I want hask-redis-mux to pass cabal check and produce a valid sdist tarball.",
      "acceptanceCriteria": [
        "cabal check on hask-redis-mux reports no errors (warnings are acceptable)",
        "cabal sdist on hask-redis-mux produces a valid tarball",
        "The tarball contains all necessary source files (lib/ modules, crc16.c, LICENSE, CHANGELOG.md)",
        "No CLI-only files are included in the tarball",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Run nix-shell --run 'cabal check' and nix-shell --run 'cabal sdist' in the project root."
    },
    {
      "id": "US-008",
      "title": "Performance verification: fill mode profiling",
      "description": "As a developer, I want to confirm fill-mode throughput is unchanged after the package split.",
      "acceptanceCriteria": [
        "Profile fill mode before split (baseline) with cabal run --enable-profiling redis-client -- fill -h localhost -d 1 -f +RTS -p",
        "Profile fill mode after split with identical parameters",
        "Compare .prof files: no new cost centres in the hot path",
        "Throughput within 2% of baseline",
        "Clean up profiling artifacts (.hp, .prof, .ps, .aux, .stat files)",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "The split is purely build-system-level so there should be zero runtime impact. This story verifies that assumption. Start Redis with docker if not running locally. Always use -f flag when running fill mode in docker."
    }
  ]
}
