# Ralph Progress Log
Started: Fri Feb 13 09:17:00 PST 2026

## Codebase Patterns
- Cabal does NOT support two .cabal files in the same directory — use subdirectories for multi-package repos
- `hask-redis-mux` library package is in `hask-redis-mux/` subdirectory; `hask-redis-mux/data` is a symlink to `../data`
- `embedFile` paths are relative to the package directory, not the repo root
- Typecheck via `nix-shell --run "cabal build all"` since `cabal` is not on PATH outside nix-shell
- `callCabal2nix` fails with two .cabal files — need source filtering or separate directories for nix
- Branch for this work: `ralph/separate-library-package` (created from main)
- When both packages define test suites with the same name, use `package:TestName` syntax (e.g., `cabal test hask-redis-mux:RespSpec`)
- A package with only named internal libraries needs a default library with `reexported-modules` for external consumers
- `callCabal2nixWithOptions "name" src "--subpath dir" {}` builds a subdirectory package with access to the full source tree
- Single `hask-redis-mux` dependency replaces all internal library refs (resp, client, cluster, etc.)

---

## 2026-02-13 - US-001 (separate-library-package)
- Created `hask-redis-mux/hask-redis-mux.cabal` with all 6 internal libraries (resp, client, crc16, redis-command-client, cluster, redis)
- redis library has visibility: public; includes GHC2021 defaults, Hackage metadata, source-repository stanza
- No CLI-only dependencies (readline, process, random, directory, filepath)
- Package lives in `hask-redis-mux/` subdirectory because cabal doesn't support two .cabal files in the same directory
- Created `hask-redis-mux/data` symlink to `../data` for file-embed `embedFile` at compile time
- Updated `cabal.project` to include `hask-redis-mux/` as a package
- Typecheck passes: `nix-shell --run 'cabal build hask-redis-mux'`
- All existing unit tests still pass
- Files changed:
  - `hask-redis-mux/hask-redis-mux.cabal` (new)
  - `hask-redis-mux/data` (symlink, new)
  - `cabal.project` (modified)
- **Learnings for future iterations:**
  - Cabal does NOT support two .cabal files in the same directory — must use subdirectories
  - `callCabal2nix` also fails with two .cabal files — need source filtering or separate directories
  - `embedFile` paths are relative to the package directory, not the repo root — symlinks solve this
  - `hs-source-dirs: ../lib/...` works for building but generates warnings about sdist — will need addressing for Hackage (US-007)
  - `packages:` in cabal.project can reference specific .cabal files or directories
---

## 2026-02-13 - US-002 (Move unit test suites to hask-redis-mux)
- Added RespSpec, ClusterSpec, and ClusterCommandSpec test suites to `hask-redis-mux/hask-redis-mux.cabal`
- Added `common test-defaults` stanza with `hspec` dependency and `hs-source-dirs: ../test`
- All three test suites pass via `nix-shell --run 'cabal test hask-redis-mux:RespSpec hask-redis-mux:ClusterSpec hask-redis-mux:ClusterCommandSpec'`
- Files changed:
  - `hask-redis-mux/hask-redis-mux.cabal` (modified)
- **Learnings for future iterations:**
  - Test suites in hask-redis-mux use `hs-source-dirs: ../test` to reference test files at repo root
  - When both packages define test suites with the same name, use `package:TestName` syntax to disambiguate (e.g., `cabal test hask-redis-mux:RespSpec`)
  - The `test-defaults` common stanza pattern mirrors the one in `redis-client.cabal` for consistency
---

## 2026-02-13 - US-003 (Update redis-client.cabal to depend on hask-redis-mux)
- Removed all 6 library stanzas (resp, client, crc16, redis-command-client, cluster, redis) from redis-client.cabal
- Removed RespSpec, ClusterSpec, ClusterCommandSpec test suites (already in hask-redis-mux)
- Replaced internal library deps with `hask-redis-mux` in redis-client executable, FillHelpersSpec, and all E2E executables
- Added default (unnamed) library to hask-redis-mux.cabal with `reexported-modules` for all public modules
- Updated default.nix to build hask-redis-mux as a dependency using `callCabal2nixWithOptions --subpath`
- Files changed:
  - `redis-client.cabal` (major rewrite — libraries and 3 test suites removed)
  - `hask-redis-mux/hask-redis-mux.cabal` (added default library with reexported-modules)
  - `default.nix` (added hask-redis-mux dependency resolution)
- **Learnings for future iterations:**
  - A package with only named internal libraries (no default library) cannot be used as a simple `build-depends` — add a default library with `reexported-modules`
  - `callCabal2nixWithOptions "name" src "--subpath dir" {}` lets nix build a package from a subdirectory while keeping access to the full source tree
  - When replacing internal library deps, a single `hask-redis-mux` dependency replaces all of `resp`, `client`, `crc16`, `redis-command-client`, `cluster`, `redis`
---
