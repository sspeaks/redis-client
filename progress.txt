# Ralph Progress Log
Started: Fri Feb 13 09:17:00 PST 2026

## Codebase Patterns
- Cabal does NOT support two .cabal files in the same directory — use subdirectories for multi-package repos
- `hask-redis-mux` library package is in `hask-redis-mux/` subdirectory; `hask-redis-mux/data` is a symlink to `../data`
- `embedFile` paths are relative to the package directory, not the repo root
- Typecheck via `nix-shell --run "cabal build all"` since `cabal` is not on PATH outside nix-shell
- `callCabal2nix` fails with two .cabal files — need source filtering or separate directories for nix
- Branch for this work: `ralph/separate-library-package` (created from main)
- When both packages define test suites with the same name, use `package:TestName` syntax (e.g., `cabal test hask-redis-mux:RespSpec`)
- A package with only named internal libraries needs a default library with `reexported-modules` for external consumers
- `callCabal2nixWithOptions "name" src "--subpath dir" {}` builds a subdirectory package with access to the full source tree
- Single `hask-redis-mux` dependency replaces all internal library refs (resp, client, cluster, etc.)
- Both `default.nix` and `flake.nix` overlay must build `hask-redis-mux` before `redis-client` using `callCabal2nixWithOptions --subpath`
- `shell.nix` delegates to `default.nix` — no separate updates needed
- Use `cabal build all` / `cabal test all` in Makefile targets to cover both packages in the multi-package setup
- For Hackage readiness: `../` paths in cabal files fail `cabal check` and `cabal sdist` — use symlinks in the subdirectory to make paths local
- `hask-redis-mux/` has symlinks: `lib -> ../lib`, `test -> ../test`, `LICENSE -> ../LICENSE`, `CHANGELOG.md -> ../CHANGELOG.md`, `data -> ../data`

---

## 2026-02-13 - US-001 (separate-library-package)
- Created `hask-redis-mux/hask-redis-mux.cabal` with all 6 internal libraries (resp, client, crc16, redis-command-client, cluster, redis)
- redis library has visibility: public; includes GHC2021 defaults, Hackage metadata, source-repository stanza
- No CLI-only dependencies (readline, process, random, directory, filepath)
- Package lives in `hask-redis-mux/` subdirectory because cabal doesn't support two .cabal files in the same directory
- Created `hask-redis-mux/data` symlink to `../data` for file-embed `embedFile` at compile time
- Updated `cabal.project` to include `hask-redis-mux/` as a package
- Typecheck passes: `nix-shell --run 'cabal build hask-redis-mux'`
- All existing unit tests still pass
- Files changed:
  - `hask-redis-mux/hask-redis-mux.cabal` (new)
  - `hask-redis-mux/data` (symlink, new)
  - `cabal.project` (modified)
- **Learnings for future iterations:**
  - Cabal does NOT support two .cabal files in the same directory — must use subdirectories
  - `callCabal2nix` also fails with two .cabal files — need source filtering or separate directories
  - `embedFile` paths are relative to the package directory, not the repo root — symlinks solve this
  - `hs-source-dirs: ../lib/...` works for building but generates warnings about sdist — will need addressing for Hackage (US-007)
  - `packages:` in cabal.project can reference specific .cabal files or directories
---

## 2026-02-13 - US-002 (Move unit test suites to hask-redis-mux)
- Added RespSpec, ClusterSpec, and ClusterCommandSpec test suites to `hask-redis-mux/hask-redis-mux.cabal`
- Added `common test-defaults` stanza with `hspec` dependency and `hs-source-dirs: ../test`
- All three test suites pass via `nix-shell --run 'cabal test hask-redis-mux:RespSpec hask-redis-mux:ClusterSpec hask-redis-mux:ClusterCommandSpec'`
- Files changed:
  - `hask-redis-mux/hask-redis-mux.cabal` (modified)
- **Learnings for future iterations:**
  - Test suites in hask-redis-mux use `hs-source-dirs: ../test` to reference test files at repo root
  - When both packages define test suites with the same name, use `package:TestName` syntax to disambiguate (e.g., `cabal test hask-redis-mux:RespSpec`)
  - The `test-defaults` common stanza pattern mirrors the one in `redis-client.cabal` for consistency
---

## 2026-02-13 - US-003 (Update redis-client.cabal to depend on hask-redis-mux)
- Removed all 6 library stanzas (resp, client, crc16, redis-command-client, cluster, redis) from redis-client.cabal
- Removed RespSpec, ClusterSpec, ClusterCommandSpec test suites (already in hask-redis-mux)
- Replaced internal library deps with `hask-redis-mux` in redis-client executable, FillHelpersSpec, and all E2E executables
- Added default (unnamed) library to hask-redis-mux.cabal with `reexported-modules` for all public modules
- Updated default.nix to build hask-redis-mux as a dependency using `callCabal2nixWithOptions --subpath`
- Files changed:
  - `redis-client.cabal` (major rewrite — libraries and 3 test suites removed)
  - `hask-redis-mux/hask-redis-mux.cabal` (added default library with reexported-modules)
  - `default.nix` (added hask-redis-mux dependency resolution)
- **Learnings for future iterations:**
  - A package with only named internal libraries (no default library) cannot be used as a simple `build-depends` — add a default library with `reexported-modules`
  - `callCabal2nixWithOptions "name" src "--subpath dir" {}` lets nix build a package from a subdirectory while keeping access to the full source tree
  - When replacing internal library deps, a single `hask-redis-mux` dependency replaces all of `resp`, `client`, `crc16`, `redis-command-client`, `cluster`, `redis`
---

## 2026-02-13 - US-004 (Update cabal.project for multi-package build)
- Verified `cabal.project` already lists both packages (`redis-client.cabal` and `hask-redis-mux/`)
- This was set up correctly in US-001 when the hask-redis-mux subdirectory was created
- Verified `nix-shell --run 'cabal build all'` succeeds — builds both hask-redis-mux library and redis-client executable
- Verified `nix-shell --run 'cabal test all'` succeeds — runs 3 hask-redis-mux test suites (RespSpec, ClusterSpec, ClusterCommandSpec) and 1 redis-client test suite (FillHelpersSpec)
- No file changes needed — all acceptance criteria already met
- Files changed: none (only prd.json and progress.txt updated)
- **Learnings for future iterations:**
  - cabal.project with `packages: redis-client.cabal hask-redis-mux/` correctly resolves both packages
  - `cabal build all` and `cabal test all` handle multi-package projects seamlessly
  - The nix-shell builds hask-redis-mux via nix first (as a dependency), then cabal only directly builds/tests redis-client components
  - If a story's work was already done as part of a prior story, just verify and mark it complete
---

## 2026-02-13 - US-005 (Update Nix build files for two-package structure)
- Updated `flake.nix` overlay to build `hask-redis-mux` via `callCabal2nixWithOptions --subpath` and pass it to `redis-client`
- `default.nix` and `shell.nix` already correct from US-003 — no changes needed
- Verified: `nix-build` succeeds, `nix build` (flake) succeeds, `nix-shell --run 'cabal build all'` succeeds
- Files changed:
  - `flake.nix` (updated overlay to include hask-redis-mux)
- **Learnings for future iterations:**
  - `default.nix` was already updated in US-003 when the dependency was first introduced — only `flake.nix` overlay needed updating
  - The flake overlay pattern mirrors `default.nix`: build `hask-redis-mux` first with `--subpath`, then pass via `inherit` to `redis-client`
  - `nix build` (flake) builds both `cabal2nix` derivations (hask-redis-mux and redis-client) before the final package
  - `shell.nix` delegates to `default.nix` so it automatically picks up multi-package changes
---

## 2026-02-13 - US-006 (Update Makefile for two-package structure)
- Updated `build` target: `cabal build all -fe2e` to explicitly build both hask-redis-mux and redis-client
- Updated `test-unit` target: `cabal build all && cabal test all` to run all 4 test suites across both packages (RespSpec, ClusterSpec, ClusterCommandSpec from hask-redis-mux; FillHelpersSpec from redis-client)
- Updated `profile` target: `cabal build all --enable-profiling` to profile both packages
- `clean` target unchanged — `rm -rf dist-newstyle` already covers both packages
- Verified: `make build`, `make test-unit`, `make clean`, `nix-build` all succeed
- Files changed:
  - `Makefile` (updated build, test-unit, profile targets to use `cabal build/test all`)
- **Learnings for future iterations:**
  - `cabal build all` explicitly builds all packages in a multi-package project; without `all`, only the "current" package is built (though dependencies are resolved transitively)
  - `cabal test all` runs test suites from all packages — simpler than listing individual test suite names
  - The `-fe2e` flag only applies to redis-client's e2e flag; hask-redis-mux has no flags, so it's harmless in `build all -fe2e`
  - `rm -rf dist-newstyle` in the clean target is the most reliable way to clean all packages since they share the same build directory
---

## 2026-02-13 - US-007 (Validate Hackage readiness of hask-redis-mux)
- Fixed all `../` relative paths in `hask-redis-mux/hask-redis-mux.cabal` to use local paths
- Created symlinks in `hask-redis-mux/`: `lib -> ../lib`, `test -> ../test`, `LICENSE -> ../LICENSE`, `CHANGELOG.md -> ../CHANGELOG.md`
- `cabal check` now passes with no errors (only missing-upper-bounds warnings, which are acceptable)
- `cabal sdist` produces valid tarball at `dist-newstyle/sdist/hask-redis-mux-0.1.0.0.tar.gz`
- Tarball contains: all lib/ source modules, lib/crc16/crc16.c, test/ sources, LICENSE, CHANGELOG.md, hask-redis-mux.cabal
- No CLI-only files (app/, data/) included in tarball
- `cabal build all`, `cabal test all`, and `nix-build` all verified passing
- Files changed:
  - `hask-redis-mux/hask-redis-mux.cabal` (all `../` paths replaced with local paths)
  - `hask-redis-mux/lib` (new symlink)
  - `hask-redis-mux/test` (new symlink)
  - `hask-redis-mux/LICENSE` (new symlink)
  - `hask-redis-mux/CHANGELOG.md` (new symlink)
- **Learnings for future iterations:**
  - `cabal check` and `cabal sdist` reject `../` relative paths — they must be within the package source tree
  - Symlinks are followed by `cabal sdist`, so placing symlinks in the package subdirectory makes paths local while keeping a single copy of source files
  - The `data/` symlink (from US-001) was already present but `data/` files are not referenced in hask-redis-mux.cabal, only in the cluster library via `file-embed` (compile-time)
  - Missing upper bounds warnings are acceptable for Hackage — they don't block upload
---

## 2026-02-13 - US-008 (Performance verification: fill mode profiling)
- Profiled fill mode on `main` (baseline) and `ralph/separate-library-package` (after split)
- Used `cabal run redis-client --enable-profiling -- fill -h localhost -d 1 -f +RTS -p`
- Started standalone Redis via `make redis-start` (docker compose on port 6379)
- Ran 2 profiling iterations on each branch for reliability
- Results comparison (averaged):
  - Baseline (main): ~0.55s total time, ~2.36B bytes allocated
  - After split: ~0.53s total time, ~2.50B bytes allocated
  - Variation within normal run-to-run noise (~15% allocation variance from random data generation)
- No new cost centres in the hot path — same top 3: genRandomSet (~72%), throwSocketErrorWaitWrite (~13%), randomNoise (~9.5%)
- No performance regression detected; throughput within 2% of baseline
- Cleaned up all profiling artifacts (.prof files)
- Stopped Redis container after profiling
- Files changed: only prd.json and progress.txt updated (verification-only story)
- **Learnings for future iterations:**
  - Fill mode allocations vary ~15% between runs due to random data generation; this is normal noise
  - Always FLUSHALL redis between profiling runs for fair comparison
  - The package split is purely build-system-level — zero runtime impact as expected
  - Use `make redis-start` / `make redis-stop` to manage standalone Redis for profiling
  - `-f` flag in fill mode prevents excessive RAM usage when Redis is in Docker
---
