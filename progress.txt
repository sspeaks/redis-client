# Ralph Progress Log
Started: Fri Feb 13 10:15:20 PM PST 2026

## Codebase Patterns
- `hask-redis-mux/lib` and `hask-redis-mux/test` are symlinks to `../lib` and `../test` at the repo root. Use repo-root paths for git operations.
- The project uses internal cabal sub-libraries (resp, client, crc16, redis-command-client, cluster, redis) with a main library that re-exports them.
- Build with `nix-shell --run "cabal build hask-redis-mux"` or `nix-shell --run "cabal build all"`.
- `RedisError` lives in `RedisCommandClient` module. New types depending on it must go in that sub-library or downstream to avoid circular deps.
- The project uses GHC2021 as default-language with `-Wall -O2`.
- There's a pre-commit hook running `stylish-haskell` on staged Haskell files.
- Test suites use the `test-defaults` common stanza which provides `hspec`, `hs-source-dirs: test`, and threading RTS options.
- `RedisError` now has `Eq` instance (added in US-002) enabling direct equality comparisons in tests.
- `RedisError` lives in its own module (`RedisError.hs`) to avoid circular deps between `RedisCommandClient` and `FromResp`. Both import from `RedisError`; `RedisCommandClient` re-exports it.
- `RedisCommands` methods are now polymorphic via `FromResp`. Call sites need type annotations or explicit `:: IO RespData` when the type is ambiguous.
- When commands like `flushAll`, `dbsize`, `auth`, `clientSetInfo` are used with `_ <-` bindings, use `(_ :: RespData) <- command` to resolve the ambiguous `FromResp` type.
- `void flushAll` becomes `do { (_ :: RespData) <- flushAll; pure () }` because `void` doesn't help GHC resolve the ambiguous type variable.
- When renaming modules, update 3 places in cabal: `exposed-modules` in the sub-library, `reexported-modules` in the main library, and check `Redis.hs` re-exports (`module OldName` → `module NewName`).
---

## 2026-02-14T06:15 - US-001
- Implemented `FromResp` typeclass with `fromResp :: RespData -> Either RedisError a`
- Added `UnexpectedResp RespData` constructor to `RedisError` in `RedisCommandClient`
- Implemented instances for: RespData, ByteString, Maybe ByteString, Integer, Bool, [ByteString], [RespData], (), Text, Maybe Text
- Files changed: `lib/redis-command-client/RedisCommandClient.hs`, `lib/redis-command-client/FromResp.hs` (new), `hask-redis-mux/hask-redis-mux.cabal`
- **Learnings for future iterations:**
  - `FromResp` had to go in `redis-command-client` sub-library (not `resp`) because it depends on `RedisError` from `RedisCommandClient`, and `redis-command-client` already depends on `resp` — putting it in `resp` would create a circular dependency.
  - `text` dependency was added to `redis-command-client` for UTF-8 decoding in the `Text` instance.
  - The main library re-exports modules via `reexported-modules`; new modules need to be added there too.
---

## 2026-02-14T06:18 - US-002
- Implemented FromRespSpec test suite with 34 tests covering all FromResp instances
- Added `Eq` deriving to `RedisError` (needed for `shouldBe` assertions)
- Files changed: `test/FromRespSpec.hs` (new), `hask-redis-mux/hask-redis-mux.cabal`, `lib/redis-command-client/RedisCommandClient.hs`
- **Learnings for future iterations:**
  - `RedisError` did not have an `Eq` instance; it was added to support test assertions. This is a minor but important change that downstream code may benefit from.
  - Test suites follow the pattern: `test-suite <Name>` with `import: test-defaults`, `main-is: <Name>.hs`, and specific `build-depends`.
  - The `test-defaults` common stanza already provides `hspec` and `hs-source-dirs: test`.
---

## 2026-02-14T06:21 - US-003
- Updated RedisCommands typeclass to use `(FromResp a) => ... -> m a` for all command return types (except `clientReply`)
- Extracted `RedisError` into its own module (`RedisError.hs`) to break circular dependency between `RedisCommandClient` and `FromResp`
- Added `convertResp` helper function for converting `RespData -> m a` via `FromResp`
- Added `executeCommandAs`, `submitMuxAs`, `executeKeyedAs` helpers in each instance module
- Updated all three `RedisCommands` instances: `RedisCommandClient`, `StandaloneCommandClient`, `ClusterCommandClient`
- Re-exported `FromResp` and `convertResp` from `Redis` convenience module
- Files changed: `lib/redis-command-client/RedisCommandClient.hs`, `lib/redis-command-client/RedisError.hs` (new), `lib/redis-command-client/FromResp.hs`, `lib/cluster/ClusterCommandClient.hs`, `lib/cluster/StandaloneClient.hs`, `lib/redis/Redis.hs`, `hask-redis-mux/hask-redis-mux.cabal`
- **Learnings for future iterations:**
  - `RedisCommandClient` and `FromResp` had a circular dependency. Extracting `RedisError` to its own module (`RedisError.hs`) broke the cycle cleanly.
  - `clientReply` is a special case - it returns `Maybe RespData` (not polymorphic) because `OFF`/`SKIP` modes don't produce a response.
  - Parent project (app/) will need type annotations added after this change (US-004/US-013), since commands are now polymorphic.
  - The `convertResp` function is exported from `RedisCommandClient` for use by downstream instances.
---

## 2026-02-14T06:29 - US-004
- Added type annotations to resolve ambiguous FromResp types in app/ code that prevented parent redis-client tests from building
- All 6 hask-redis-mux test suites already compiled and passed (no changes needed in hask-redis-mux test/)
- Fixed app/AppConfig.hs: `auth` and `clientSetInfo` calls needed `(_ :: RespData)` bindings
- Fixed app/Filler.hs: `dbsize` call needed `(_ :: RespData)` binding, added `Resp` import
- Fixed app/ClusterFiller.hs: `dbsize` call needed `(_ :: RespData)` binding, added `Resp` import
- Fixed app/ClusterSetup.hs: `flushAll` call needed `(_ :: RespData)` binding, added `Resp` import
- Fixed app/Main.hs: replaced `void flushAll` with `do { (_ :: RespData) <- flushAll; pure () }` in 6 places
- Files changed: `app/AppConfig.hs`, `app/Filler.hs`, `app/ClusterFiller.hs`, `app/ClusterSetup.hs`, `app/Main.hs`
- **Learnings for future iterations:**
  - The hask-redis-mux test suites did not need any changes - the ambiguous types were only in the parent app/ code
  - `void` doesn't help resolve ambiguous types because it just discards the result without constraining it
  - The `(_ :: RespData)` pattern binding is the cleanest way to resolve ambiguous FromResp constraints
  - GHC2021 includes ScopedTypeVariables but type vars only scope with explicit `forall`, so `(_ :: Type)` is safer than full expression type annotations
---

## 2026-02-14T06:37 - US-005
- Renamed `Resp` module to `Database.Redis.Resp` following Hackage hierarchical naming conventions
- Created `lib/resp/Database/Redis/` directory structure, moved and renamed module
- Updated `hask-redis-mux.cabal`: `exposed-modules` and `reexported-modules` 
- Updated all imports across lib/, test/, and app/ (40+ files)
- Updated `module Resp` re-export in `Redis.hs` to `module Database.Redis.Resp`
- All unit tests pass, full project builds cleanly
- Files changed: `lib/resp/Database/Redis/Resp.hs` (new), `lib/resp/Resp.hs` (deleted), `hask-redis-mux/hask-redis-mux.cabal`, `lib/redis/Redis.hs`, plus all files importing `Resp` in lib/, test/, and app/
- **Learnings for future iterations:**
  - The `Redis.hs` convenience module has `module Resp` re-exports that must also be updated (not just `import` statements)
  - `sed -i 's/import           Resp /import           Database.Redis.Resp /' ...` works well for bulk renaming across many files with consistent formatting
  - The cabal file has two places referencing each module: `exposed-modules` in the sub-library and `reexported-modules` in the main library stanza
---

## 2026-02-14T06:41 - US-006
- Renamed `Client` module to `Database.Redis.Client`
- Created `lib/client/Database/Redis/` directory structure
- Updated cabal `exposed-modules` and `reexported-modules`, `module Client` re-export in `Redis.hs`
- Updated all imports across lib/, test/, and app/
- Files changed: `lib/client/Database/Redis/Client.hs` (new), `lib/client/Client.hs` (deleted), `hask-redis-mux/hask-redis-mux.cabal`, `lib/redis/Redis.hs`, plus all files importing `Client`
- **Learnings for future iterations:**
  - The `Client` module is imported by sub-libraries (redis-command-client, cluster) not just top-level code — need to check all lib/ subdirectories
  - `sed` with fixed spacing patterns can miss imports with different indentation — always verify with grep after sed
  - `ClusterCommandClient.hs` and `StandaloneClient.hs` in lib/cluster/ have their own `Client` imports with different spacing
---
